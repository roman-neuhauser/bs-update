.\" This document is in the public domain.
.\" vim: fdm=marker
.
.\" FRONT MATTER {{{
.Dd Jul 16, 2012
.Os
.Dt BS-UPDATE 1
.
.Sh NAME
.Nm bs-update
.Nd Update packages in a Build Service from upstream sources.
.\" FRONT MATTER }}}
.
.\" SYNOPSIS {{{
.Sh SYNOPSIS
.Nm
.Fl h
.Nm
.Op Fl A Ar BSAPI
.Op Fl C
.Op Fl P Ar PROJECT
.Op Fl b
.Op Fl d Ar URL
.Op Fl m Ar COMMITMSG
.Op Fl n
.Op Fl p Ar PACKAGE
.Oo Fl s Ar SPECFILE Oc Ns ...
.Op Fl t Ar TARBALL
.Ar TAG
.Op Ar VERSION
.\" SYNOPSIS }}}
.
.\" DESCRIPTION {{{
.Sh DESCRIPTION
.Nm
makes it easier to keep packages in a Build Service
up-to-date with respect to their upstream sources.
.
.Pp
.
Given a Build Service API URL, project and package names, a tarball
URL, and a version number,
.Nm
will
.
.Pp
.
.Bl -enum -compact
.It
fetch the tarball from the URL,
.It
check out the package from the Build Service,
.It
update the tarball source with the downloaded tarball,
.It
update the spec file source with a template from that tarball,
.It
commit the changes.
.El
.
.Ss Options
.
.Bl -tag -width "xx"
.It Fl h
Display a usage description.
.
.It Fl A Ar BSAPI
Use Build Service at
.Ar BSAPI
(URL or alias).
.
.It Fl C
Skip the
.Nm osc
.Cm commit
step.
.
.It Fl P Ar PROJECT
Update Build Service package of
.Ar PROJECT .
.
.It Fl b
Run
.Nm osc
.Ar build
before
.Nm osc
.Ar commit .
If the build fails,
.Nm
aborts.
See
.Va $bsu_osc_build .
.
.It Fl d Ar URL
Retrieve the source tarball from
.Ar URL .
If
.Ar URL
is
.Dq \&. ,
.Nm
uses
.Xr git-archive 1
or
.Xr hg-archive 1
in
.Ev PWD
as appropriate.
Otherwise,
.Nm
uses
.Xr wget 1 .
.
.It Fl m Ar COMMITMSG
Use
.Ar COMMITMSG
for the commit in Build Service.
Defaults to
.Dq Update to version Ar VERSION .
.
.It Fl n
Report values derived from
configuration files and command line arguments, then exit.
.
.It Fl p Ar PACKAGE
Update Build Service
.Ar PACKAGE .
.
.It Fl s Ar SPECFILE
Use
.Ar SPECFILE Ns Li .in
from
.Ar TARBALL ,
commit
.Ar SPECFILE
into the Build Service.
All occurrences of
.Li __VERSION__
in
.Ar SPECFILE
outside of comments are replaced with
.Ar VERSION .
.Ar SPECFILE
can be a real
.Li .spec
file (RPM) or a
.Pa PKGBUILD
file (ArchLinux).
May be given more than once, all files are processed.
.
.It Fl t Ar TARBALL
Use
.Ar TARBALL
for the name of the downloaded file.
.
.It Ar TAG
Update the package from
.Ar TAG .
.
.It Ar VERSION
Update the package to
.Ar VERSION .
.
If
.Ar VERSION
is not given, it is derived using
.Fn bsu_version_hook ,
and if that does not exist,
from
.Ar TAG
by stripping the initial
.Dq Li v
if any.
.El
.
.Ss Operation
.
.Nm
reads configuration files, then it parses command line arguments.
Each configuration variable has a corresponding command line option.
Command line options and arguments take precedence over configuration
files.
.Pp
Values from both the configuration and the command line are subject
to shell expansion.
.
.\" DESCRIPTION }}}
.\" .Sh IMPLEMENTATION NOTES
.\" ENVIRONMENT {{{
.Sh ENVIRONMENT
.Nm
itself does not use any environment variables.
It is, however, implemented in terms of third-party commands
which
.Em do
use them.
This means
.Nm
may be influenced by environment variables used by
.Xr git 1 ,
.Xr hg 1 ,
.Xr osc 1 ,
.Xr tar 1 ,
.Xr wget 1 ,
.Xr zsh 1 ,
possibly others.
.\" ENVIRONMENT }}}
.\" FILES {{{
.Sh FILES
.Nm
recognizes two optional configuration files,
.Pa .bs-update-hooks
and
.Pa .bs-update .
They are sourced, in order, from the current directory before
command line arguments are processed.
These two files are expected to provide
.Nm
with any of the following:
.Ss Shell functions
. Bl -ohang
. It Fn bsu_tarball_hook
The tarball may need finalization before it is checked into
the Build Service, eg.
.Nm autoconf ,
.Nm git
submodules
or
.Nm npm .
If this function exists it is executed at the root of the extracted
tarball before it is packed again.
.
. It Fn bsu_version_hook
If the
.Ar VERSION
argument is not given and this function exists it is executed with
.Ar $1
set to the value of the
.Ar TAG
argument, and its output is used as the final version string.
. El
.Ss Variables
. Bl -tag -compact -width "x"
. It Va bsu_bs_apiurl       Pq Fl A
. It Va bsu_bs_commit       Pq Fl C
. It Va bsu_bs_commitmsg    Pq Fl m
. It Va bsu_bs_package      Pq Fl p
. It Va bsu_bs_project      Pq Fl P
. It Va bsu_dloadurl        Pq Fl d
. It Va bsu_dryrun          Pq Fl n
. It Va bsu_specfiles       Pq Fl s
. It Va bsu_tarball         Pq Fl t
. It Va bsu_test_build      Pq Fl b
. It Va bsu_osc_build       Po Options and arguments for Nm osc Ar build . Pc
. El
.\" FILES }}}
.\" EXAMPLES {{{
.Sh EXAMPLES
.
.Ss Interactive Use by Upstream Maintainer
.
This is a real-world example showing common
.Pa .bs-update
setup and the use of
.Nm
to test changes in the package and finally produce
a new package version.
It assumes the user maintains both the upstream software
and its package in the Build Service.
.Pp
We need a working copy to hack on:
.
.Bd -literal -offset 2n
git clone git@github.com:roman-neuhauser/bs-update.git
cd bs-update
.Ed
.
.Pp
Since we're going to use
.Nm
repeatedly, it makes sense to employ a configuration file,
.Pa .bs-update .
Everything can still be overridden using options on the command line:
.
.Bd -literal -offset 2n
cat > .bs-update
u=roman-neuhauser
p=bs-update
bsu_bs_apiurl=https://api.opensuse.org
bsu_bs_package='$p'
bsu_bs_project='home:$u'
bsu_dloadurl='https://github.com/$u/$p/tarball/$bsu_tag'
^D
.Ed
.
.Pp
Commit some changes:
.
.Bd -literal -offset 2n
vim bs-update.in
make check
git commit bs-update.in
.Ed
.
.Pp
Build the package locally, using the currently checked out revision.
Does not commit into the Build Service:
.
.Bd -literal -offset 2n
bs-update -Cbd . HEAD 999
.Ed
.
.Pp
If it was ok we can tag it and publish the tag:
.
.Bd -literal -offset 2n
git tag -a v42.69
git push origin master v42.69
.Ed
.
.Pp
Commit the new release into the Build Service:
.
.Bd -literal -offset 2n
bs-update v42.69
.Ed
.
.Ss Snapshot-generating Cronjob
.
This example demonstrates using
.Nm
with no
.Pa .bs-update
file.
A new version of the package is created, based on a tarball
of the upstream master branch.
.
.Bd -literal -offset 2n
ts=$(date +%Y%m%d%H%M%S)
bs-update \\
  -P home:roman-neuhauser \\
  -p bs-update-snapshot \\
  -d https://github.com/roman-neuhauser/bs-update/tarball/master \\
  -t bs-update-$ts.tar.gz \\
  master $ts
.Ed
.\" EXAMPLES }}}
.\" DIAGNOSTICS {{{
.Sh DIAGNOSTICS
.Nm
exits with
.Li 0
on success, and with
.Li >0
otherwise.
.\" DIAGNOSTICS }}}
.\" .Sh COMPATIBILITY
.\" SEE ALSO {{{
.Sh SEE ALSO
.Xr git 1 ,
the openSUSE Build Service
.Aq https://build.opensuse.org/ ,
and its wiki
.Aq http://en.opensuse.org/Portal:Build_Service .
.\" SEE ALSO }}}
.\" .Sh STANDARDS
.\" .Sh HISTORY
.\" AUTHORS {{{
.Sh AUTHORS
.
.Nm
and this manual page are written by
.An Roman Neuhauser Aq Mt neuhauser@sigpipe.cz .
.Pp
See
.Lk https://github.com/roman-neuhauser/bs-update/ .
.\" AUTHORS }}}
.\" BUGS {{{
.Sh BUGS
No doubt plentiful.
Please report them at
.Lk https://github.com/roman-neuhauser/bs-update/issues .
.\" BUGS }}}
