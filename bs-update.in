#!/bin/sh
# vim: fdm=marker cms=\ #\ %s

set -o errexit
set -o nounset
set -o posix

usage() # {{{
{
  local self="$SELF" exit=${1?} fd=1
  test $exit -ne 0 && fd=2
  {
    if test $exit -eq 1; then
      printf "%s: missing <tag> argument\n" "$self"
    elif test $exit -eq 2; then
      printf "%s: option -%c requires an argument\n" "$self" "$2"
    elif test $exit -eq 3; then
      printf "%s: unknown option -%c\n" "$self" "$2"
    elif test $exit -eq 4; then
      printf "%s: no %s specified\n" "$self" "$2"
    fi
    printf "%s: Usage: %s {-h|[options] <tag>}\n" "$self" "$self"
    if test $exit -ne 0; then
      printf "%s: Use \"%s -h\" to see the full option listing.\n" "$self" "$self"
    else
      printf "  Options:\n"
      printf "    %-16s  %s\n" \
        "-h"              "Display this message" \
        "-A BSAPI"        "Use Build Service at BSAPI (URL or alias)" \
        "-P PROJECT"      "Update Build Service package of PROJECT" \
        "-p PACKAGE"      "Update Build Service package named PACKAGE" \
        "-t URL"          "Fetch the tarball from URL"
    fi
  } >&$fd
  if test $exit -eq 0; then
    exit 0
  else
    exit 1
  fi
} # }}}

expand() # {{{
{
  local prev='' result="${1?}"
  while test "$result" != "$prev"; do
    prev="$result"
    result="$(eval echo "$result")"
  done
  echo "$result"
} # }}}

SELF=$(basename "$0")

bs_apiurl=
package=
bs_project=
dloadurl=

dry_run=0

if test -f .bs-update; then
  . $PWD/.bs-update
fi

while getopts :A:P:hnp:t: optname; do
  case $optname in
  A) bs_apiurl=$OPTARG ;;
  P) bs_project=$OPTARG ;;
  h) usage 0 ;;
  n) dry_run=1 ;;
  p) package=$OPTARG ;;
  t) dloadurl=$OPTARG ;;
  :) usage 2 $OPTARG ;; # option-argument missing
  ?) usage 3 $OPTARG ;; # unknown option
  esac
done
shift $(($OPTIND - 1))

if test $# -lt 1; then
  usage 1
fi

tag=$1

version=${tag#v}
tarball=$package-$version.tar.gz

bs_apiurl="$(expand \"$bs_apiurl\")"
bs_project="$(expand \"$bs_project\")"
dloadurl="$(expand \"$dloadurl\")"

test -n "$package" || usage 4 package
test -n "$bs_project" || usage 4 project
test -n "$dloadurl" || usage 4 tarball

pkgdir=$bs_project/$package
specfile=$package.spec

if test 0 -ne $dry_run; then
  printf '%16s = "%s"\n' \
    bs_apiurl "$bs_apiurl" \
    bs_project "$bs_project" \
    package "$package" \
    dloadurl "$dloadurl" \
    tag "$tag" \
    version "$version" \
    pkgdir "$pkgdir" \
    tarball "$tarball" \
    specfile "$specfile"
  exit $?
fi

osc() # {{{
{
  command osc ${bs_apiurl:+-A "$bs_apiurl"} ${1+"$@"}
} # }}}
fetch() # {{{
{
  local url=${1?} tarball=${2?}
  wget -qO $tarball $url
} # }}}
repack() # {{{
{
  local tarball=${1?}
  local dir=${tarball%.tar.gz}
  mkdir $dir
  tar -xzf $tarball --strip-components=1 -C $dir
  if test -x $dir/pre-package ;then
    pushd $dir
    ./pre-package
    popd
  fi
  tar -czf $tarball $dir
  rm -rf $dir
} # }}}
extract() # {{{
{
  local tarball=${1?}
  local file=${tarball%.tar.gz}/${2?}
  tar -xzf $tarball --strip-components=1 $file
} # }}}
update() # {{{
{
  case $1 in
  *.spec)  update_specfile "$@" ;;
  *.tar.*) update_tarball "$@" ;;
  esac
} # }}}
update_specfile() # {{{
{
  local specfile=${1?} version=${2?}
  cp $specfile.in $specfile
  sed -ri '/^Version:/s/__VERSION__/'$version'/' $specfile
  if osc st $specfile | grep -q '^?'; then
    osc add $specfile
  fi
} # }}}
update_tarball() # {{{
{
  local tarball=${1?} rewrite=0
  if test -f $pkgdir/$tarball; then
    rewrite=1
  fi
  if test 0 -eq $rewrite && test -f $pkgdir/$package-*.tar.gz; then
    osc rm $pkgdir/$package-*.tar.gz
  fi
  mv $tarball $pkgdir
  if test 0 -eq $rewrite; then
    osc add $pkgdir/$tarball
  fi
} # }}}
exithook() # {{{
{
  rm -rf $root
} # }}}

trap exithook EXIT
root=$(mktemp -d)
echo "$SELF: root=$root"
cd $root
osc co $pkgdir
fetch $dloadurl $tarball
repack $tarball
update $tarball
cd $pkgdir
extract $tarball $specfile.in
update $specfile $version
#osc build
osc ci -m "Update to version $version"
